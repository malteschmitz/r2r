const colors = {
  pink: "#D10369",
  orange: "#EE7400",
  green: "#30AC5A"
};

const options = {
  num_points: 100,
  character_distance: 0.8,
  max_resistor_length: 3,
  top_tolerance: 0.1,
  bottom_tolerance: 0.1,
  right_tolerance: 0.1,
  vertical_position: 0.5,
  vertical_tolerance: 0.5,
  resistor_tolerance: 0.5,
  resistor_small_tolerance: 0.1,
  min_width_for_large_resistor: 1.5,
  icon_scale: 0.15
};

const font = [
  "m5.16 5.54q-.101-.132-.171-.287-.0698-.163-.147-.388-.0155-.0388-.0931-.233-.0698-.194-.163-.334-.489.0698-.799.0698-.171 0-.38-.00776-.202-.0155-.303-.0155-.388-.031-.621-.031-.0931.124-.163.264-.0621.14-.163.419-.14.404-.241.574-.0698.116-.272.116-.171 0-.318-.0698-.14-.0776-.14-.21.0621-.295.194-.621.14-.334.396-.885l.31-.761q.256-.652.466-1.12.217-.466.567-1.1.0466-.0931.155-.155.109-.0699.241-.0699.147 0 .21.0233.0698.0155.109.0621.0388.0388.116.171.264.411.45.846.194.435.489 1.2l.163.411q.217.559.373.939.163.373.357.683.124.202.124.279 0 .186-.116.287-.109.0931-.287.0931-.225 0-.341-.155zm-.799-1.88q-.124-.264-.357-.916-.241-.698-.481-1.11-.147.373-.435.962-.194.365-.442 1.06.497.0621 1.07.0621.411 0 .644-.0543z", 
  "m4.5 3.04q.567.0698.838.365.279.287.279.714t-.318.807q-.31.38-.799.59-.217.0854-.574.124-.349.0388-.722.0388-.621 0-1.27-.116-.116-.0233-.248-.116-.124-.0931-.124-.272-.0078-.714-.0543-1.99l-.0078-.427q-.031-.993-.031-1.56 0-.101.116-.233.124-.14.295-.155.101 0 .194-.00776.877-.0854 1.17-.0854.582 0 1.02.116.45.109.745.404.109.124.179.318.0698.186.0698.365.0078.38-.202.698-.202.318-.559.419zm-1.21-1.66q-.264 0-.551.031-.279.031-.473.0776l.0466 1.47.279-.00776q.675-.0698.993-.116.202-.0466.396-.179.194-.14.318-.287.132-.155.132-.233 0-.116-.0466-.233-.0466-.124-.101-.179-.21-.202-.427-.272-.217-.0698-.567-.0698zm-.955 3.62q.396.0543.753.0543.784 0 1.23-.202.458-.21.458-.792 0-.233-.349-.388-.349-.155-.753-.155-.272 0-.691.0621-.334.0466-.652.0621.0155.466.0155.59 0 .241-.0078.365z", 
  "m5.34 1.49q.116.14.163.225.0466.0854.0466.163 0 .0931-.124.217-.116.124-.233.124-.155 0-.248-.0466-.0931-.0466-.155-.147-.147-.233-.341-.411-.194-.186-.52-.186-.318 0-.714.147t-.582.365q-.419.512-.419 1.36 0 .675.419 1.16.442.497 1.12.497.31 0 .675-.109.373-.116.59-.373h-.0078q.14-.147.349-.147.124 0 .233.109.116.109.116.217 0 .116-.0388.21-.031.0854-.124.194-.318.349-.815.489-.489.132-1.12.132-.52 0-1-.248-.473-.248-.784-.629-.155-.225-.303-.644-.14-.427-.14-.691 0-.675.202-1.28.21-.613.621-.978.272-.248.784-.373.512-.124.939-.124.341 0 .582.101.248.0931.427.256.179.155.404.427z", 
  "m5.18 1.68q.256.303.419.683.171.38.171.916 0 .396-.186.83-.179.427-.466.691-.295.287-.582.466-.279.179-.753.295-.473.109-1.21.109-.481 0-.706-.163-.217-.163-.217-.489 0-.217.0621-.73.0621-.497.0621-.683 0-.737-.0233-1.24-.0155-.512-.0388-.939-.217 0-.303-.109-.0854-.109-.0854-.225 0-.186.179-.279.179-.101.613-.101 1.05 0 1.8.194.761.194 1.27.776zm-2.74 3.26q.186.031.528.031.504 0 .962-.21.458-.217.737-.598.279-.388.279-.893 0-.528-.186-.9-.179-.373-.574-.613-.279-.179-.691-.256-.411-.0854-1-.0854 0 .473.0155.792l.0155.241q.031.667.031 1 0 .318-.0388.753-.031.435-.0776.737z", 
  "m5.3 5.16q.0078.163-.0388.233-.0466.0621-.186.132-.21.101-.497.132-.279.031-.722.031h-.528q-.691 0-1.02-.233-.334-.241-.419-.574-.0854-.334-.101-.861-.0078-.179-.0078-.528 0-.761.132-2.03.0388-.373.272-.536.233-.171.528-.171.241 0 .784-.0155l.683-.00776q.419 0 .605.0233.233.0466.349.109.116.0543.124.194 0 .155-.101.303-.101.147-.31.147-.241 0-.691-.031t-.683-.031q-.21 0-.38.0233-.217.0155-.31.0543-.0931.0388-.101.132-.0854.846-.0698 1.18.179.0233.357.0233.179 0 .489-.031.0776-.00776.194-.0155.116-.00776.264-.00776.0854 0 .272.0155l.241.00776q.357 0 .357.256 0 .155-.0854.248-.0854.0931-.303.14-.295.0543-.955.0543h-.473q-.147 0-.365-.0155-.0078.14-.0078.404 0 .341.0078.481.0233.543.753.543.248 0 .528.0155l.287.00776q.202 0 .334-.0388.132-.0466.256-.0776.132-.0388.241-.0388.147 0 .225.116.0776.109.0776.241z", 
  "m2.73 5.38q-.0233.116-.14.202-.109.0776-.31.0776-.171 0-.272-.0931-.0931-.0931-.101-.194.0466-.326.0466-.978 0-.388-.0466-1.2-.0543-.761-.0543-1.35 0-.318.031-.652 0-.109.124-.233.132-.124.357-.155.737-.0776 1.81-.0776h.248q.279 0 .543.101.272.101.272.349 0 .163-.0776.256-.0776.0931-.287.0931-.101 0-.233-.0155t-.186-.0233q-.295-.0466-.458-.0466-.9 0-1.36.124 0 .256.0155.83l.0078.497q.404 0 .722-.031.318-.0388.365-.0466.404-.0466.536-.0466.186 0 .31.0854.132.0776.132.248 0 .388-.543.388-.132 0-.233.00776-.101.00776-.171.0155-.279.031-.442.031-.357 0-.605.0233 0 .287.0233.605 0 .101.0078.31.0155.21.0155.38 0 .147-.0078.272t-.0388.241z", 
  "m4.99 2.07q-.116-.0776-.225-.179-.279-.217-.473-.318-.194-.109-.435-.109-.341 0-.683.0854-.334.0854-.551.241-.326.241-.442.636-.116.388-.116.955 0 .598.373 1.06.225.256.543.396.326.14.652.14.753 0 1.12-.419.264-.334.264-.815 0-.0854-.124-.116-.124-.031-.357-.031-.116 0-.365-.031-.0698-.00776-.155-.0155-.0776-.00776-.163-.00776-.225 0-.357-.0854t-.132-.217q0-.186.124-.272.124-.0931.334-.0931.241 0 .737.031.466.031.66.031.272 0 .435.171.171.171.171.497 0 .303-.132.706-.132.404-.373.722-.233.318-.691.489-.45.171-.993.171-.442 0-.877-.155-.435-.163-.73-.435-.357-.334-.567-.792-.202-.466-.202-.924 0-.706.248-1.32.256-.621.776-.962.233-.155.714-.256.481-.101.846-.101.512 0 .931.225.419.225.652.559.0931.14.0931.248 0 .124-.109.233-.109.109-.217.109-.0466 0-.109-.0155-.0621-.0155-.0931-.0388z", 
  "m4.84 2.88q-.0078-.124-.0078-.373v-.295q0-.295-.0155-.442-.0155-.124-.0155-.644 0-.186.109-.287.116-.109.31-.109.248 0 .334.109.0854.109.0854.357v.295l-.0078.854q-.0078.248-.0078.745l.0078.636q.0078.147.0078.411 0 .21.0155.598.0155.357.0155.536 0 .147-.0854.272-.0776.124-.217.124-.543 0-.543-.365 0-.202.0155-.45.0155-.179.0155-.543 0-.256-.0155-.737-.365.031-1.26.031-.559 0-.869 0-.31-.00776-.45-.0388l-.0078.893q0 .0854.0388.458.0388.248.0388.435 0 .116-.14.225-.132.101-.248.101-.279 0-.38-.132-.101-.14-.101-.419l-.0078-.613q-.0078-.109-.0078-.303 0-.287-.0155-.784-.0155-.45-.0155-.652 0-.303.0155-.846.0155-.512.0155-.761 0-.248.124-.334.124-.0854.279-.0854.435 0 .435.287 0 .512-.0233.978-.0155.59-.0155.861.225.0543.473.0698t.698.0155q.916 0 1.42-.0776z", 
  "m3.89 1.38q-.031.667-.031.955 0 .629.0388 1.39.031.9.031 1.33.295-.0388.357-.0388.171 0 .272.0854.101.0854.101.264 0 .116-.0931.179-.0931.0621-.326.0931-.225.0233-.66.0233-.481 0-.722-.031t-.334-.116q-.0931-.0931-.0931-.272 0-.132.0854-.179.0854-.0466.241-.0466l.163.00776.256.0155-.0388-.916q-.0466-.745-.0466-1.37 0-.334.0233-.916l.0155-.427q-.264.0155-.411.0155-.171 0-.233-.0621-.0543-.0621-.0543-.256 0-.217.295-.279.303-.0621.916-.0621.473 0 .706.031.241.031.241.14 0 .264-.116.349-.109.0776-.427.0776z", 
  "m2.56 4.37q0 .357.101.52.101.155.318.155.543 0 .737-.442.202-.442.202-1.21 0-.373-.0466-1.04-.0466-.636-.0466-.947-.83 0-.83-.326 0-.194.0621-.256.0698-.0621.21-.0621.0854 0 .186.0155.101.00776.147.00776.155.0233.295.0233.256 0 .473-.0233.279-.0155.419-.0155.279 0 .388.0543.116.0543.116.21 0 .163-.0854.233-.0776.0621-.233.0931l-.357.0388q-.0078.512.0621 1.23.0078.109.031.411.0233.295.0233.543 0 1.01-.427 1.56-.427.543-1.27.543-.528 0-.885-.303-.349-.31-.349-.924 0-.171.124-.272.124-.109.334-.109.147 0 .225.101.0776.101.0776.194z", 
  "m4.99 4.37q.295.295.466.512.179.21.179.365 0 .217-.124.326-.116.109-.295.109-.124 0-.256-.124t-.241-.264-.14-.179q-.179-.217-.698-.869-.512-.66-.714-.947-.0621.0388-.186.155-.0466.0388-.241.202-.194.155-.427.318 0 .0466.0233.698.0155.481.0155.629 0 .124-.0854.256-.0854.124-.256.124-.248 0-.357-.0854-.109-.0854-.132-.248-.0621-.373-.0621-.737 0-.404.0621-1.18.0621-.73.0621-1.09 0-.14-.0155-.404-.0078-.21-.0466-.388-.031-.248-.031-.349 0-.248.109-.357.109-.109.334-.109.171 0 .279.101.116.0931.132.256.0388.66.0388 1.02-.0078.179-.031.504-.0155.318-.031.411.272-.202 1.09-.947.823-.753 1.1-1.02.0388-.0388.132-.132.101-.101.186-.14.0854-.0388.186-.0388.14 0 .241.132.109.124.109.272 0 .0854-.0698.186-.0621.0931-.225.256-.567.59-1.26 1.23.179.287.59.83.419.536.59.714z", 
  "m2.29.731q.334 0 .388.349.0931.66.0931 1.62l-.0078.978v.295q0 .481-.0233.893.326.031.582.031.225 0 .598-.0155l.473-.00776q.217 0 .357.0233.147.0155.303.0931.163.0698.163.264 0 .155-.101.279-.0931.124-.225.124-.0931 0-.295-.031-.365-.0543-.698-.0543-.109 0-.248.0155-.132.00776-.194.00776-.186.0233-.373.0233-.38 0-.683-.0388-.155-.0155-.31-.116-.155-.109-.155-.31 0-.241.0233-.598.031-.683.031-1.22 0-.31-.0233-.667t-.031-.466q-.0543-.636-.0543-1.09 0-.202.0931-.295.101-.0931.318-.0931z", 
  "m5.53.755q.109 0 .264.147.163.14.163.241 0 .473-.031 1.3-.0078.202-.0155.489-.0078.279-.0078.652 0 1.18.14 1.74-.0078.186-.147.272-.14.0776-.279.0776-.31 0-.411-.217-.0931-.217-.0931-.621 0-1.5.031-2.76-.893.993-1.39 1.67 0 0-.14.0931-.132.116-.217.116-.202 0-.334-.101-.132-.101-.256-.295l-.373-.528q-.388-.543-.567-.823 0 .714.0698 1.94.0543.706.0543 1.06 0 .186-.0931.318-.0931.124-.295.124-.202 0-.334-.0776-.124-.0776-.132-.233.0078-.132.0078-.435 0-.605-.0388-1.47l-.0155-.419-.0155-.543q-.0078-.241-.0155-.559-.0078-.326-.0078-.706 0-.466.504-.466.155 0 .31.0776.163.0776.241.225.0621.272.458.9.396.629.776 1.18.341-.435.559-.652.373-.38.613-.706.248-.326.536-.784.0698-.0931.202-.155.132-.0698.279-.0698z", 
  "m4.73 1.3q0-.225.101-.388.109-.171.318-.171.179 0 .318.0698t.14.233q0 .318-.031.893-.031.559-.031.83 0 .427.031 1.14.031.683.031 1 0 .256-.0078.38 0 .124-.14.248-.132.116-.411.116-.147 0-.256-.0466-.101-.0543-.14-.116-.365-.442-1.06-1.51-.784-1.19-1.28-1.82.0621.559.0621 1.37 0 .357-.0155.931-.0078.567-.031.745-.031.225-.14.349-.101.116-.326.116-.171 0-.256-.0931-.0776-.101-.0931-.341-.0078-.318.0388-.955.0078-.101.0233-.349.0155-.248.0155-.442 0-.536-.0543-1.23-.0466-.761-.0466-1.13 0-.186.132-.287.14-.101.318-.101.155 0 .326.0776.667.838 1.81 2.5l.73 1.12q.0078-.124.0078-.349 0-.396-.0155-.854t-.0233-.621q-.0388-.753-.0388-1.33z", 
  "m3.42.724q.52 0 .947.132.427.124.698.373.489.442.683.97.202.52.202 1.33 0 .171-.0466.31-.0388.14-.132.357-.116.241-.14.38-.155.272-.512.52-.349.248-.761.404t-.722.155q-1.5 0-2.13-1.02-.179-.287-.279-.598-.0931-.31-.0931-.605 0-.792.279-1.37.287-.59.792-.916.303-.179.629-.295.334-.124.59-.124zm-1.48 2.73q0 .419.186.691.194.272.59.59.326.124.442.163.116.031.264.031.784 0 1.25-.427t.466-1.17q0-.59-.132-.931t-.473-.613q-.179-.147-.458-.217-.272-.0698-.59-.0698-.481 0-.83.287-.349.279-.536.73-.179.45-.179.939z", 
  "m3.74 3.91q-.295 0-.504-.0155-.202-.0233-.536-.0698 0 .334-.0155.815l-.0078.598q0 .202-.109.318-.109.109-.256.109-.256 0-.38-.0621-.116-.0698-.116-.241 0-.303.031-.636.0931-.807.0931-1.82 0-.706-.0388-1.33-.132-.0543-.233-.14-.0931-.0854-.101-.171 0-.202.147-.326.147-.124.45-.124.248 0 .613-.0388.0854-.00776.295-.0233.21-.0155.365-.0155.636 0 .986.124.357.124.714.411.388.605.388.854 0 .799-.473 1.29-.466.489-1.31.489zm-.171-2.51q-.248 0-.442.031-.186.0233-.435.0854.0388.598.0388 1.04 0 .334-.0233.559.334.0698.52.0931.194.0155.435.0155.574 0 .807-.295.241-.295.241-.698 0-.116-.0698-.287-.0621-.171-.116-.225-.21-.186-.411-.248-.202-.0698-.543-.0698z", 
  "m3.34.724q.52 0 .947.132.427.124.698.373.489.442.683.97.202.52.202 1.33 0 .264-.248.885-.14.272-.295.427-.147.155-.458.373.264.419.411.574.155.163.349.163.0621 0 .0931-.00776.0233-.00776.0698-.00776.109 0 .171.0698.0698.0776.0698.179 0 .0543-.031.116-.031.0621-.0854.0931-.147.0931-.256.116-.109.031-.396.031-.303 0-.543-.272-.233-.264-.489-.737-.334.124-.675.124-1.5 0-2.13-1.02-.179-.287-.279-.598-.0931-.31-.0931-.605 0-.792.279-1.38.287-.59.792-.908.295-.186.621-.303.334-.116.598-.116zm-1.5 2.71q0 .287.0854.512.0931.217.264.411.14-.295.396-.442.256-.147.605-.147.365 0 .621.132.256.132.38.279.124.14.31.404.551-.442.551-1.25 0-.605-.132-.939-.124-.334-.473-.621-.186-.155-.466-.233-.272-.0776-.582-.0776-.473 0-.83.295-.357.287-.543.745-.186.45-.186.931zm1.49.924q-.217 0-.404.0931-.186.0854-.256.326l.101.0776q.163.0621.287.0931.124.0233.279.0233.256 0 .551-.0854-.14-.256-.279-.388-.132-.14-.279-.14z", 
  "m5.37 4.93q.116 0 .186.101.0776.101.0776.217 0 .202-.155.31-.147.101-.388.101-.357 0-.574-.124-.217-.124-.388-.466-.0543-.124-.132-.404-.0698-.279-.147-.442-.0698-.171-.241-.287-.163-.116-.45-.124l-.171.00776q-.264.0155-.396.0155-.155 0-.295-.0233.0155 1.02.0155 1.57 0 .14-.14.233-.132.0931-.303.0931-.202 0-.318-.155-.0931-.186-.0931-.551 0-.124.0155-.357l.0078-.341q0-.473.0388-1.02.031-.621.031-.908 0-.241-.0466-.644-.0078-.0776-.0233-.248-.0155-.179-.0155-.318 0-.101.0854-.186.0854-.0854.171-.109.636-.101 1.26-.101 1.01 0 1.65.38.644.38.644 1.16 0 .233-.124.489-.116.248-.295.388-.303.264-.652.341.0155.0155.171.155.155.14.21.295l.101.31q.132.38.21.528.0776.14.202.14.116 0 .14-.0155.031-.0155.132-.0155zm-3.08-1.78q.233.0155.326.0155.14 0 .388-.0155l.365-.00776q.241 0 .497-.109t.427-.303q.171-.202.171-.45 0-.442-.357-.644-.357-.202-1.11-.202-.287 0-.675.0776.0155.279.0155.404 0 .147-.0155.442l-.0078.225q-.0233.326-.0233.567z", 
  "m5.4 4.25q0 .365-.171.629-.163.256-.543.473-.256.155-.598.233-.341.0776-.691.0776-.357 0-.885-.233-.38-.186-.605-.442-.217-.256-.217-.559 0-.21.0931-.303.0931-.101.303-.101.109 0 .225.0931.116.0854.14.171.109.318.38.489.272.163.675.163.466 0 .776-.171.318-.171.318-.458 0-.279-.341-.497-.341-.217-.698-.303-.512-.14-.908-.334-.411-.202-.613-.497-.202-.295-.202-.621 0-.303.21-.613.21-.318.497-.458.155-.0776.528-.163.38-.0931.551-.0931.217 0 .458.0543t.411.155q.341.194.504.349.163.155.163.388 0 .14-.109.248-.101.109-.357.109-.0621 0-.124-.0543-.0621-.0543-.155-.163-.124-.163-.241-.217-.124-.0466-.31-.0854-.186-.0466-.349-.0466-.186 0-.388.0776-.202.0776-.341.225-.132.14-.132.326 0 .155.14.272.147.109.349.179.233.0931.504.163.357.109.582.202.233.0854.45.217.38.225.551.466.171.233.171.652z", 
  "m1.45 1.14q0-.334.489-.334.21 0 .799.0155.652.031.986.031.272 0 .66-.031.264-.0155.334-.0155.427.0155.722.155.0854.0388.14.0931.0543.0543.0543.179 0 .171-.109.295-.109.116-.264.116-.171 0-.497-.0466-.287-.0543-.504-.0543-.21 0-.318.00776-.0233.256-.0233 1.23 0 1.16.0698 2.34l.0155.225q0 .318-.365.318-.287 0-.388-.132-.101-.14-.101-.419 0-.551-.031-1.37-.031-.683-.031-.97 0-.194.0466-1.19l-.908.00776q-.435 0-.605-.0776-.171-.0854-.171-.373z", 
  "m2.34 1.16q0 .225-.0155.706l-.0078.605q0 .737.109 1.23.0698.326.147.497.0854.163.256.373.132.155.341.248.217.0854.427.0854.365 0 .605-.109.248-.109.373-.373.233-.481.233-1.19 0-.442-.0543-1.08-.0466-.698-.0466-1.02 0-.179.171-.287.171-.109.31-.109.241 0 .326.132.0931.132.0931.31 0 .225-.0233.388-.0155.202-.0155.287 0 .295.031.931.0078.163.0155.38.0078.217.0078.466 0 .528-.248 1-.248.466-.698.753t-1.02.287q-.893 0-1.37-.473-.481-.481-.652-1.33-.101-.504-.132-1.15-.0233-.644-.0233-1.63 0-.124.116-.233.124-.109.264-.109.489 0 .489.411z", 
  "m2.2.964q.287.854.652 1.88.365 1.02.667 1.76.225-.722.621-1.73.396-1.02.737-1.83.101-.241.341-.241.225 0 .341.0931.116.0854.116.303 0 .0854-.0233.147-.0233.0621-.0699.163-.241.473-.481 1.09-.241.613-.59 1.56.0155-.0388-.217.582l-.256.667q-.0466.124-.155.194-.101.0621-.233.0621t-.295-.0621q-.155-.0698-.225-.14-.264-.504-.675-1.46-.404-.955-.698-1.76l-.116-.318q-.116-.326-.171-.497-.0543-.179-.0543-.287 0-.155.171-.248.179-.0931.341-.0931.0854 0 .163.0388.0776.0388.109.124z", 
  "m5.78 1.17q.0466-.163.14-.264.0931-.109.202-.109.264 0 .38.101.116.101.116.349 0 .0698-.109.396-.241.737-.528 1.82-.0698.248-.116.435-.0388.186-.0699.31-.186.799-.326 1.2-.0466.116-.163.186-.116.0621-.248.0621-.132 0-.264-.0543-.124-.0621-.179-.14-.186-.365-.559-1.32-.365-.955-.574-1.62-.365.939-.761 2.2-.155.504-.217.683-.0543.116-.155.186-.101.0621-.225.0621-.14 0-.272-.0543-.132-.0621-.178-.14-.101-.171-.217-.528-.109-.357-.295-1l-.194-.66q-.202-.644-.349-1.32-.147-.675-.147-.807 0-.163.163-.256.163-.101.326-.101.0931 0 .194.0621.101.0543.132.194.272 1.45.799 3.37.217-.536.636-1.89.0543-.179.163-.528.116-.349.194-.582.031-.116.155-.186.132-.0698.264-.0698.171 0 .279.0854.109.0854.14.186.0155.0466.318 1.07.303 1.02.714 1.91.155-.458.373-1.47l.116-.512q.21-.823.341-1.27z", 
  "m5.24.747q.155 0 .233.101.0854.0931.0854.256 0 .179-.0931.404-.272.248-.613.66t-.807 1.02q.427.698.691 1.06.264.349.504.481.101.0543.241.0931.178.0543.264.109.0854.0543.0854.163 0 .217-.202.326-.202.101-.489.101-.373 0-.737-.411-.357-.411-.861-1.23-.489.644-.815 1.05-.326.396-.59.644-.0543.0466-.155.0776-.101.0233-.171.0233-.171 0-.295-.14-.116-.14-.124-.287 0-.0233.0854-.155.0854-.132.264-.303.194-.147.504-.528.318-.38.854-1.08l-.225-.357q-.295-.466-.435-.667t-.264-.303q-.124-.109-.264-.109-.0466 0-.147.031-.0931.0233-.155.0233-.0854 0-.155-.031-.194-.0854-.194-.256 0-.0776.031-.132.0621-.14.256-.256.202-.124.543-.124.318 0 .551.163.233.163.427.442.202.279.551.877.768-1.04 1.09-1.4.186-.217.295-.279.109-.0621.241-.0621z", 
  "m5.65 1.1q0 .14-.241.411-.171.194-.745 1.06-.489.737-.753 1.09.008.83.0621 1.22.0233.233.0233.334 0 .256-.0931.349-.0854.0854-.303.0854-.163 0-.31-.0931-.14-.101-.14-.241 0-.404-.0233-1.51 0-.0543-.14-.287-.124-.217-.613-.838-.473-.613-.714-.962-.233-.357-.233-.543 0-.163.147-.256.155-.101.334-.101.225 0 .365.21.0776.109.241.419.116.225.264.473.147.248.272.404l.217.264q.233.279.233.287.233-.233.419-.512.186-.287.45-.73l.295-.481.132-.202q.0699-.0931.163-.147.0931-.0543.256-.0543.147 0 .287.0854.147.0854.147.256z", 
  "m2.08 5.52q-.341-.031-.458-.163-.116-.14-.116-.287 0-.0931.0388-.21.0388-.116.0776-.163.365-.45 1.37-1.58 1-1.13 1.34-1.51l-.303-.0155q-.411-.0233-.691-.0233-.101 0-.512.0388-.256.0388-.466.0388-.303 0-.442-.0543-.132-.0621-.163-.14-.0233-.0776-.0233-.217 0-.101.0776-.202.0854-.109.202-.124.31-.0388.83-.0698.52-.0388.846-.0388.986 0 1.39.101.101.031.171.155.0699.124.0699.194 0 .0931-.031.194-.0233.101-.0698.171-.101.179-.466.652-.365.466-.776.939-.435.512-.893 1.02-.45.504-.582.644.217-.00776.667-.0388.73-.0466 1.09-.0466.287 0 .636.0388.357.0388.536.155.0543.031.101.179.0543.147.0543.241 0 .101-.101.179-.0931.0776-.264.0776-.0155 0-.341-.031-.675-.0776-.893-.0776l-.551.00776q-.373.0155-.567.0155-.473 0-.792-.0388z", 
  "m4.98 1.28q.256.396.411.908.155.504.155 1.03 0 .629-.217 1.2-.21.567-.636.924-.419.357-1.02.357-.567 0-1.04-.287-.473-.295-.714-.683-.178-.287-.272-.644-.0931-.365-.0931-.73 0-.636.264-1.24.272-.605.745-.97.45-.334 1.03-.334.644 0 1.39.473zm-2.08.536q-.0699.116-.14.21-.171.256-.248.435-.0776.171-.14.528-.0311.163-.0311.38 0 .551.217.955.225.396.613.536.186.0698.419.0698.582 0 .877-.512.303-.52.303-1.28 0-.706-.264-1.16-.264-.458-.815-.458-.225 0-.388.0698-.155.0698-.404.225z", 
  "m4.05 1.58q-.0776 1.52-.0776 2.42 0 .466.0233.885.0621.0466.241.0466l.178-.00776q.109-.0155.202-.0155.202 0 .31.0698.116.0698.116.272 0 .194-.116.303-.109.109-.458.109-.295 0-.714-.0466-.101-.00776-.194-.0155-.0931-.00776-.171-.00776-.427.00776-.636.031-.21.0233-.473.0233-.241 0-.241-.365 0-.349.45-.349.0699 0 .225.0155.132.0233.279.0233.0854 0 .14-.00776.008-.52.0543-1.51.0466-1.16.0466-1.72-.0388.00776-.272.109-.357.179-.528.179-.0931 0-.171-.0931-.0776-.101-.0776-.233 0-.132.163-.256t.528-.326q.202-.101.388-.225.0466-.031.132-.0621.0931-.031.14-.031.202 0 .365.0854.171.0776.171.21z", 
  "m2.89 4.85q.264.0155.349.0155.264 0 .466-.00776.21-.00776.357-.0155.38-.0233.683-.0233.295 0 .435.155t.14.411q0 .124-.163.202-.163.0698-.334.0698-.147 0-.613-.031-.559-.0466-.877-.0466-.171 0-.404.0233-.0931.00776-.225.0155-.132.00776-.295.00776-.31 0-.473-.0854t-.163-.31q0-.194.155-.396t.435-.481l.186-.186q.124-.132.458-.45.551-.497.854-.877.31-.38.31-.753 0-.241-.233-.388-.225-.155-.52-.155-.45 0-.652.202-.194.194-.194.567 0 .0931-.109.171-.101.0698-.256.0698-.217 0-.303-.155-.0854-.155-.0854-.38 0-.357.217-.629.217-.279.59-.435.38-.155.838-.155.326 0 .675.163.357.155.59.427.241.264.241.582 0 .481-.241.916-.241.435-.567.776-.318.334-.83.792-.248.21-.442.396z", 
  "m3.91 2.56q.636.14 1.06.551t.419.955q0 .326-.155.636-.248.497-.745.745-.489.248-1.13.248-.404 0-.722-.147-.318-.155-.629-.411-.116-.109-.21-.31-.0854-.202-.0854-.334 0-.171.0931-.272.101-.109.264-.109.163 0 .256.0776.0931.0776.225.248.124.163.225.264.101.0931.272.163.171.0698.427.0698.52 0 .815-.256t.295-.722q0-.179-.194-.357-.194-.186-.365-.264-.101-.0543-.373-.109-.365-.0931-.551-.179-.178-.0931-.178-.287 0-.132.116-.256.116-.132.349-.326.233-.194.349-.318.116-.132.116-.264-.147-.0388-.442-.0388-.132 0-.396.0155-.233.0155-.357.0155-.279 0-.481-.0931-.194-.0931-.194-.241 0-.163.031-.256.031-.101.116-.124.0543-.0233.194-.0233.38 0 .66.0233.31.0155.473.0155l.644-.00776q.792 0 .792.38 0 .287-.295.652-.287.357-.683.644z", 
  "m2.99 1q0 .38-.14.885-.132.497-.388 1.23l-.178.536q.132.0233.272.0233.241 0 .722-.0466t.691-.0466l-.008-.854q-.0155-.885-.0155-1.3 0-.551.365-.551.287 0 .365.147.0854.147.0854.442 0 .303-.0466.939-.008.124-.0233.411-.0155.287-.0155.497l.008.248.155-.00776q.186-.0155.287-.0155.186 0 .357.124.171.116.171.279 0 .194-.0621.303-.0543.109-.132.109-.132 0-.334-.031-.0466 0-.14-.00776-.0931-.0155-.178-.0155l-.132.00776.008 1.05q0 .163-.109.248-.109.0854-.248.0854-.171 0-.303-.109-.132-.109-.132-.272 0-.52.0155-.815.008-.0698.008-.171-.233-.00776-.807.0543-.543.0621-.823.0621-.357 0-.605-.101-.241-.101-.241-.318 0-.21.0854-.512t.256-.815q.0776-.202.116-.334.14-.396.21-.667.0699-.279.155-.675.031-.124.132-.186.101-.0621.233-.0621.14 0 .248.0698.116.0621.116.171z", 
  "m2.88 1.59q-.0543.217-.0699.574-.0155.31-.0466.466.225-.0931.427-.116.202-.031.512-.031.481 0 .838.225.357.217.543.59.186.365.186.784 0 .163-.109.442-.109.272-.225.419-.272.357-.629.551-.357.186-.776.186-.318 0-.582-.0854-.256-.0931-.551-.248-.303-.163-.442-.334-.132-.179-.132-.442 0-.14.116-.225.124-.0931.233-.0931.0699 0 .124.0388.0543.0388.178.155l.194.186q.186.155.365.233.186.0776.45.0776.241 0 .388-.0621.295-.116.458-.303.171-.186.171-.598 0-.396-.264-.613-.264-.225-.893-.225-.0854 0-.248.0466-.163.0466-.318.101-.373.124-.458.124-.109 0-.217-.0931-.109-.0931-.109-.248.14-.939.14-1.56l-.008-.194q-.0155-.14-.0155-.233 0-.14.147-.21.155-.0776.318-.0776.14 0 .605.0466l.373.031q.0699.00776.21.00776l.287-.00776q.0854-.00776.248-.00776.233 0 .388.0698t.155.225q0 .241-.0776.349t-.179.109q-.0931 0-.31-.031-.287-.031-.675-.031-.272 0-.722.031z", 
  "m3.88 1.55q-.264.101-.45.264-.186.155-.334.38l-.124.194q-.14.21-.21.341-.0699.132-.0931.279.38-.388 1.09-.388.303 0 .636.171.341.171.551.396.132.147.217.45.0931.303.0931.644 0 .272-.163.559-.163.279-.404.489-.233.21-.435.264-.31.0776-.536.0776-.512 0-.947-.279t-.691-.745q-.256-.473-.256-1.02 0-.761.365-1.45.373-.698.978-1.13.101-.0698.357-.147.264-.0854.466-.0854.38 0 .38.303 0 .179-.132.279-.124.101-.357.163zm-.31 3.41q.179 0 .303-.0155.124-.0233.225-.0854.155-.109.272-.256.124-.155.124-.295 0-.536-.264-.753-.256-.217-.605-.225-.179 0-.411.101-.225.0931-.388.248-.155.155-.155.303 0 .334.14.559.147.217.357.318t.404.101z", 
  "m5.34 1.13q-.101.473-.256.939-.147.466-.38 1.07-.396 1.06-.559 1.72-.132.442-.248.636t-.272.194q-.124 0-.334-.147-.0543-.0698-.0543-.194 0-.101.0543-.295.0543-.202.132-.442l.0931-.279q.101-.334.341-.9.179-.435.318-.838.147-.404.287-.962-.404.124-.799.124-.194 0-.59-.0543-.326-.0466-.466-.0466.008.116.116.442.132.334.132.504 0 .101-.0699.171-.0699.0698-.225.0698-.202 0-.31-.124-.101-.132-.171-.295-.0621-.171-.0931-.233-.109-.248-.171-.512-.0621-.272-.0621-.481 0-.124.0621-.217.0699-.0931.155-.0931.116.0155.349.0621.373.0621.621.101.256.031.543.031.706 0 1.09-.248.0543-.031.163-.031.202 0 .404.101.202.0931.202.233z", 
  "m4.33 3.09q.473.186.761.497t.287.714q0 .116-.0543.295-.0466.171-.132.295-.512.792-1.81.792-.675 0-1.17-.272-.497-.279-.497-.83 0-.784 1.08-1.34-1.01-.373-1.01-1.1 0-.442.248-.745.248-.303.652-.45.411-.147.893-.147.357 0 .73.171.373.163.512.427.14.295.14.551 0 .334-.14.613-.132.279-.489.536zm-.807-.233q.248-.163.38-.264.14-.109.233-.256.101-.155.101-.357 0-.233-.186-.388-.186-.155-.45-.155-.567 0-.792.194-.217.194-.217.458 0 .21.14.357.14.14.31.225.178.0776.481.186zm1.03 1.39q0-.132-.171-.279-.163-.147-.388-.256-.225-.116-.38-.155-.264.109-.582.349-.318.233-.388.341-.0776.109-.109.186-.0233.0698-.0233.171 0 .116.14.225.14.101.334.163.194.0621.334.0621.551 0 .893-.217.341-.225.341-.59z", 
  "m3.19 4.9q.264-.0854.504-.31.248-.225.411-.504.171-.287.202-.551-.217.155-.442.217-.225.0621-.52.0621-.396 0-.652-.132-.256-.14-.543-.396-.0466-.0466-.116-.202-.0699-.163-.124-.396-.0543-.241-.0543-.489 0-.225.14-.473.14-.248.349-.442.217-.202.411-.287.179-.0776.411-.132.241-.0621.404-.0621.551 0 .924.256.38.256.559.683.179.427.179.947 0 .893-.396 1.63-.396.73-1 1.13-.101.0698-.349.155-.241.0776-.442.0776-.155 0-.272-.14-.116-.14-.116-.318 0-.124.0854-.171.0854-.0543.279-.109zm.38-3.44q-.124 0-.295.0543-.163.0466-.279.116-.132.0776-.256.241-.116.155-.116.241 0 1.02.823 1.02.186 0 .411-.0776.233-.0854.388-.233.155-.147.155-.334 0-.512-.217-.768-.21-.256-.613-.256z"
];
const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");

const groundPath = "m.147-.826c-.219-.007-.389.12-.459.329-.185.503-.265 1.03-.265 1.56 0 .265.0266.529.106.794v.0264c-.714.0529-1.46.132-2.17.212-.238.0265-.45.185-.45.45 0 .238.211.502.45.45 1.24-.159 2.49-.185 3.76-.159.609.0265 1.22.053 1.83.106.318.0265.635.0795.953.106.318.0265.661.0795.952-.0264.238-.0529.423-.371.185-.582-.503-.397-1.3-.423-1.9-.476-.635-.0529-1.27-.106-1.93-.106h-.794c0-.0529-.0264-.106-.0264-.186-.0265-.159-.0527-.397-.0527-.608 0-.476.0525-.847.238-1.32.0794-.238-.106-.503-.317-.556-.0331-.007-.0654-.0104-.0966-.0114zm1.95 4.48c-.423 0-.82.0268-1.24.0532-.82.0265-1.61.0795-2.43.106-.688.0265-.688 1.08 0 1.06.82-.0265 1.61-.0795 2.43-.106.397-.0264.794-.0268 1.19-.0532.423-.0265.873-.0525 1.24-.238.238-.132.265-.556 0-.661-.37-.159-.794-.159-1.19-.159zm-1.37 1.92c-.265-.002-.538.0173-.796.0372-.132.0265-.265.0528-.371.159-.0794.0794-.159.238-.159.371s.0528.291.159.371c.106.0794.238.159.371.159.344-.0529.661-.0528 1.01-.0264.159 0 .318.0264.476.0264.212.0265.476.0796.661-.0527.212-.159.317-.397.185-.609-.132-.238-.423-.291-.661-.344-.212-.0529-.423-.0796-.608-.0796-.086-.007-.174-.01-.263-.0108z";
const topPath = "m.956-3.48c-.265-.265-.635-.45-1.01-.423-.344 0-.661.159-.926.397-.582.556-.556 1.53-.0794 2.14.0265.0529.0794.0794.159.0794.132.212.317.37.529.476v.0529c0 .159-.0265.344-.0265.529-.0265.344-.0265.714-.0265 1.06 0 .265.238.503.503.503s.503-.212.503-.503c0-.344 0-.714-.0265-1.06 0-.185-.0265-.344-.0265-.529.423-.132.767-.476.926-.926.265-.609-.0265-1.35-.503-1.8zm-.344 1.56c-.0265.0265-.0265.0529-.0529.0794 0 0-.0265.0265-.0265.0529l-.0265.0265c-.0265.0265-.0529.0794-.106.106-.0529.0529-.0265.0265 0 0-.0265 0-.0265.0265-.0529.0265-.0265.0265-.0529.0265-.0794.0265h-.0265-.0265c-.0265 0-.0529 0-.0529.0265h-.0265-.0794c-.0265 0-.0529 0-.0794-.0265-.0265 0-.0794-.0265-.0794-.0265h-.0265l-.0529-.0529c-.0265-.0265-.0265-.0265-.0529-.0529 0-.0265-.0265-.0529-.0529-.0794 0 0 0-.0265-.0265-.0265v-.0529-.0265-.0265-.0265c.0529-.212-.0529-.476-.291-.529h-.0529c0-.0265 0-.0529.0265-.0529.0265-.0265.0265-.0529.0529-.0794.0265-.0265.0265-.0529.0529-.0794.0265-.0265.0794-.0794.106-.106.0265 0 .0265-.0265.0265-.0265.0265 0 .0529-.0265.0794-.0529h.0265c.0265 0 .0529-.0265.0794-.0265h.0265.132c.0265 0 .0529.0265.0794.0265h.0265c.0265 0 .0529.0265.0794.0529.0265.0265.0529.0529.106.0529 0 0 .0794.0794.106.0794.0265.0265.0794.0794.0529.0794.0265.0529.0529.0794.0794.132.0265.0265.0265.0529.0265.0794.0265.0529.0265.106.0529.132 0 .0265 0 .0529.0265.0794v.0265.132.0529c.0529.0265.0529.0529.0265.0794z";
const rightPath = "m4.78-1.55c-.661.106-1.24.688-1.3 1.38-.582-.0265-1.14-.0265-1.72-.0265-.741 0-1.48 0-2.25.0265-.529 0-.529.847 0 .82.767-.0265 1.51-.0265 2.28-.0529.582-.0265 1.19-.0529 1.77-.106.106.238.238.45.45.635.265.212.609.37.952.344.318.212.767.238 1.14.0529.714-.397.741-1.38.45-2.04-.159-.344-.397-.661-.741-.847-.318-.212-.661-.265-1.03-.185zm.714.952s.0265 0 .0265.0265c-.0265-.0265.0265.0265.0529.0265l.0794.0794s.0265.0265.0265.0529c.0265.0529.0529.106.0794.132.0265.0265.0265.0529.0529.0794v.0265c.0265.0529.0265.106.0529.159 0 .0265.0265.0529.0265.106v.185.0265.0265.0265c0 .0529-.0265.132-.0529.159 0 0 0 .0265-.0265.0265-.0265.0265-.0265.0529-.0529.0794-.0265.0265-.0529.0529-.0794.0794-.0265 0-.0265 0-.0265.0265-.0265 0-.0265 0-.0529.0265h-.0529c-.0265 0-.0529-.0265-.0794-.0265s-.0265-.0265-.0529-.0265v-.0265c0-.238-.212-.45-.423-.423-.106 0-.212.0529-.291.106 0 0-.0265-.0265-.0265-.0265-.0265-.0529-.0529-.106-.0794-.159 0-.0265-.0265-.0529-.0265-.0794s0-.0529-.0265-.0794v-.132-.0265c0-.0265.0265-.0529.0265-.0794v-.0265s0-.0265.0265-.0265c.0265-.0265.0265-.0529.0529-.0794l.0265-.0265c.0265-.0265.0265-.0529.0529-.0529l.0529-.0529c.0265 0 .0529-.0265.0529-.0529.0265-.0265.0529-.0265.106-.0529.0265 0 .0265-.0265.0265-.0265.0529-.0265.106-.0265.159-.0529h.0529.0794.0265c.0529 0 .0794.0265.132.0265 0 .0265.0265.0529.0794.0529z";

function value(id, val) {
  const node = document.getElementById(id);
  if (val) {
    node.value = val;
  }
  return +node.value;
} 

function angle(a, b) {
  const dx = b.x - a.x;
  const dy = b.y - a.y;
  if (dx === 0 || dy === 0) {
    return 0;
  }
  return Math.atan(dy / dx) * 180 / Math.PI;
}

function distance(a, b) {
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  return Math.sqrt(dx*dx + dy*dy);
}

function createPath(d) {
  const node = document.createElementNS("http://www.w3.org/2000/svg", "path");
  node.setAttribute("d", d);
  return node;
}

function createIcon(p, d) {
  const node = createPath(d);
  node.setAttribute("transform", `translate(${p.x},${p.y}) scale(${options.icon_scale})`);
  node.setAttribute("fill", colors.pink);
  return node;
}

function createResistor(a, b) {
  const large = "m20.4-.771c-.695.185-1.45-.188-2.1-.398-.76-.214-1.63-.353-2.33.0965-.488.299-.798.79-1 1.31-.0821-2.02.154-4.05.731-5.98.274-.943-1.16-1.39-1.47-.453-.633 2.01-1.29 4.03-1.92 6.04-.362 1.15-.672 2.36-1.17 3.5-.392-2.93-.0398-5.91.283-8.83.113-.869-1.23-1.05-1.5-.269-.785 2.54-1.6 5.05-2.38 7.59-.308-1.65-.323-3.35-.312-5.02.000751-.715-1.02-1.15-1.41-.451-.541.986-.951 2.03-1.2 3.1-1.67-.0634-3.31-.0994-4.97-.163-.978-.0373-1.04 1.5-.0584 1.53 1.88.0715 3.73.116 5.61.187.238.00906.507-.113.648-.32.159 1.38.453 2.72 1.01 4.01.268.619 1.23.47 1.41-.132l1.15-3.69c.0179 1.62.195 3.21.638 4.79.187.643 1 .78 1.39.238 1.03-1.42 1.52-3.17 2.04-4.85.0542.664.135 1.33.242 2 .0866.506.689.688 1.09.492.673-.292 1.04-.966 1.23-1.62.151-.497.182-1.29.62-1.67.438-.38 1.19-.00756 1.66.143.785.242 1.62.485 2.43.278.962-.228.622-1.72-.341-1.47z";
  const largeWidth = 20;
  const small = "m-.336.806c.714.0359 1.43.0453 2.14.0812.635.0348 1.32.123 1.88-.293.294-.234.484-.576.594-.918.219 1.46.358 2.94.365 4.45.0146.9 1.33 1.13 1.58.233.585-2.21 1.2-4.43 1.78-6.64.124.637.247 1.3.318 1.94.168 1.33.229 2.68.211 4.02-.00944.714.859 1.04 1.37.574.937-.861.662-2 .941-3.11.168-.686 1.37-.547 2.11-.485 1.71.142 1.86-1.48.445-1.52-1.41-.034-2.42-.564-3.41.349l-.0536.0522c-.048-.371-.0964-.716-.144-1.09-.195-1.25-.35-3.58-2.04-3.6-.344-.00455-.691.229-.775.572l-1.06 3.96c-.145-1.01-.37-2.02-.622-3-.201-.796-1.29-.758-1.53-.0203-.166.527-.358 1.03-.523 1.55l-.275.817c-.0279.105-.138.422-.165.501-.0265-.00035-.0797.0254-.106.0251l-.317-.0042c-.291-.00385-.582-.0341-.873-.038-.582-.0341-1.16-.0418-1.75-.076-1.11.0118-1.13 1.63-.101 1.67z";
  const smallWidth = 13;
  const alpha = angle(a, b);
  const width = distance(a,b);
  let node, scale;
  if (width <= options.min_width_for_large_resistor) {
    node = createPath(small);
    scale = width / smallWidth;
  } else {
    node = createPath(large);
    scale = width / largeWidth;
  }
  node.setAttribute("transform", `translate(${a.x},${a.y}) scale(${scale}) rotate(${alpha})`);
  node.setAttribute("fill", colors.pink);
  return node;
}

function getPoints(node) {
  const len = node.getTotalLength();
  const nodes = [];
  for (let i = 0; i < options.num_points; i++) {
    const point = node.getPointAtLength(len * i / options.num_points);
    nodes.push(point);
  }
  return nodes;
}

function randomElement(array) {
  return array[Math.floor(Math.random() * array.length)];
}

function last(array) {
  return array[array.length  - 1];
}

function randomRightElement(points, tolerance) {
  const max = Math.max(...points.map(p => p.x));
  return randomElement(points.filter(p => Math.abs(p.x - max) <= tolerance));
}

function randomLeftElement(points, tolerance) {
  const min = Math.min(...points.map(p => p.x));
  return randomElement(points.filter(p => Math.abs(p.x - min) <= tolerance));
}

function randomBottomElement(points, tolerance) {
  const max = Math.max(...points.map(p => p.y));
  return randomElement(points.filter(p => Math.abs(p.y - max) <= tolerance));
}

function randomTopElement(points, tolerance) {
  const min = Math.min(...points.map(p => p.y));
  return randomElement(points.filter(p => Math.abs(p.y - min) <= tolerance));
}

function verticalRangePoints(points, position, tolerance) {
  points.sort((a,b) => a.y - b.y);
  const min = points[0].y;
  const max = last(points).y;
  const pos = min + (max - min) * position;
  const middles = points.filter(p => Math.abs(p.y - pos) <= tolerance);
  return middles;
}

function kerning(a, b) {
  const data = {
    "LO": -0.5,
    "LT": -1
  };
  return data[a + b] || 0;
}

const svg = document.getElementById("svg");
const inputString = document.getElementById("inputString");
const configForm = document.getElementById("configForm");
const downloadSvg = document.getElementById("downloadSvg");
const downloadPng = document.getElementById("downloadPng");
let currentName = "";
let currentWidth = 0;

function generate() {
  options.character_distance = value("character_distance");
  options.max_resistor_length = value("max_resistor_length");
  options.vertical_position = value("vertical_position");
  options.vertical_tolerance = value("vertical_tolerance");
  options.resistor_tolerance = value("resistor_tolerance");

  svg.innerHTML = "";
  const background = document.createElementNS("http://www.w3.org/2000/svg", "g");
  svg.appendChild(background);

  const text = inputString.value;
  const characters = text.toUpperCase().split("").filter(c => alphabet.includes(c));
  currentName = characters.join("");

  const paths = characters.map((c, i) => {
    const node = createPath(font[alphabet.indexOf(c)]);
    node.setAttribute("fill", (i % 2 === 0) ? colors.green : colors.orange);
    svg.appendChild(node);
    return node;
  });

  const points = paths.map(p => {
    const c = p.cloneNode();
    c.setAttribute("d", c.getAttribute("d").split("z")[0] + "z");
    return getPoints(c);
  });
  const mins = points.map(ps => Math.min(...ps.map(p => p.x)));
  const maxs = points.map(ps => Math.max(...ps.map(p => p.x)));
  const widths = mins.map((min, i) => maxs[i] - min);

  let dx = 1;
  const offsets = [dx - mins[0]];
  widths.slice(0, -1).forEach((w, i) => {
    dx += w + options.character_distance + kerning(characters[i], characters[i + 1]);
    offsets[i + 1] = dx - mins[i + 1];
  });
  offsets.forEach((offset, i) => {
    paths[i].setAttribute("transform", `translate(${offset}, 0)`);
    points[i].forEach(p => p.x += offset);
  });
  const width = dx + last(widths) + 2;
  svg.setAttribute("viewBox", `0 -0.5 ${width} 8`);
  currentWidth = width;

  points.slice(0, -1).forEach((leftPoints, i) => {
    const rightPoints = points[i + 1];
    let left = randomRightElement(verticalRangePoints(leftPoints, options.vertical_position, options.vertical_tolerance), options.resistor_tolerance);
    let right = randomLeftElement(rightPoints.filter(p => Math.abs(p.y - left.y) <= options.resistor_tolerance), options.resistor_tolerance);
    if (distance(left, right) < options.max_resistor_length) {
      background.append(createResistor(left, right));
    } else {
      left = randomRightElement(leftPoints, options.resistor_small_tolerance);
      right = randomLeftElement(rightPoints.filter(p => Math.abs(p.y - left.y) <= options.resistor_tolerance), options.resistor_tolerance);
      background.append(createResistor(left, right));
    }
  });

  points.slice(1,-1).forEach(ps => {
    const top = randomTopElement(ps, options.top_tolerance);
    background.appendChild(createIcon(top, topPath));
  });

  const bottom = randomBottomElement(points[0], options.bottom_tolerance);
  background.appendChild(createIcon(bottom, groundPath));

  const right = randomRightElement(last(points), options.right_tolerance);
  background.appendChild(createIcon(right, rightPath));
}

value("character_distance", options.character_distance);
value("max_resistor_length", options.max_resistor_length);
value("vertical_position", options.vertical_position);
value("vertical_tolerance", options.vertical_tolerance);
value("resistor_tolerance", options.resistor_tolerance);

generate();

configForm.onsubmit = (event) => {
  event.preventDefault();
  generate();
};

const rangeIds = ["character_distance", "max_resistor_length", "vertical_position", "vertical_tolerance", "resistor_tolerance"];
rangeIds.forEach(id => {
  const node = document.getElementById(id);
  node.onchange = () => generate();
});

function getSvgDataUrl(includeDimensions) {
  let data = svg.innerHTML;
  const viewBox = svg.getAttribute("viewBox");
  let dimensions = "";
  if (includeDimensions) {
    // explicit dimensions are needed since otherwise PNG export silently fails in Firefox
    // https://bugzilla.mozilla.org/show_bug.cgi?id=700533
    dimensions = ` width="1920" height="${1920 * 8 / currentWidth}"`;
  }
  data = `<svg viewBox="${viewBox}"${dimensions} xmlns="http://www.w3.org/2000/svg">${data}</svg>`;
  data = `data:image/svg+xml,${encodeURIComponent(data)}`;
  return data;
}

function getPngDataUrl(callback) {
  const canvas = document.createElement("canvas");
  canvas.width = 1920;
  canvas.height = 1920 * 8 / currentWidth;
  const ctx = canvas.getContext("2d");
  const img = new Image();
  img.onload = () => {
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    const png = canvas.toDataURL("image/png");  
    callback(png);
  };
  img.src = getSvgDataUrl(true);
}

function downloadUrl(url, filename, done) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    if (done) {
      done();
    }
  });
}

downloadSvg.onclick = () => {
  const url = getSvgDataUrl();
  downloadUrl(url, `${currentName || "r2r"}.svg`);
};

downloadPng.onclick = () => {
  getPngDataUrl(url => downloadUrl(url, `${currentName || "r2r"}.png`, () => URL.revokeObjectURL(url)));
};